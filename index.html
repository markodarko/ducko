<HTML>

<style>
canvas {
	display:block;
	background:black;
	user-select:none;
	}
*{
	margin: 0;
   	padding: 0;
}
</style>

<center>
<canvas id='gamewindow' width = '128' height = '64'></canvas>
</center>
<script src='controls.js'></script>
<script src='gfx/image_data.js'></script>
<script src='gfx/colors.js'></script>
<script src='gfx/sprites.js'></script>
<script>

const LEFT = 37, RIGHT = 39, UP = 38, DOWN = 40;
const SCALE = 5, SPRITE_WIDTH = 8;

var canvas = document.getElementById('gamewindow');
var ctx = canvas.getContext('2d');
canvas.height *= SCALE;
canvas.width  *= SCALE;
ctx.scale(SCALE,SCALE);

class dashFX{
  constructor(x,y,w,h){
	this.x = x;this.y=y;this.w=w;this.h=h
	this.dead = false;
	this.time = 10;
  }
  update(){
	if (this.time>0)this.time--;
	else this.dead = true;
  }
  draw(){
	if (this.dead)return;
	ctx.fillStyle = 'white';
	ctx.fillRect(this.x,this.y,this.w,this.h)
  }
}

class Actor{
  constructor(x,y,sprite = SPRITES.wall, colors = [COLORS.black,COLORS.red]){
  	this.x = x;
	this.y = y;
	this.sprite = sprite;
	this.colors = colors; 
	}
  draw(){
	this.sprite.updateFrame();
	this.sprite.drawImg(this.x*SPRITE_WIDTH,this.y*SPRITE_WIDTH,this.colors);
  };
}

class Hero extends Actor{
  constructor(x,y){
	super(x,y);
	this.dash = false;
	this.sprite = SPRITES.player;
	this.colors = [COLORS.Dgrey,COLORS.orange];
  }
  draw(){
	if (this.dash)this.dash.draw()
	super.draw()
  }
  update(){ 
	if (this.dash)this.dash.update()
	let oldx = this.x, oldy=this.y;
	if (controller.getkeypress(RIGHT)){
	while(this.gridCheck(this.x+1,this.y)) this.x += 1;
	this.dash = new dashFX(oldx*8,oldy*8,(this.x-oldx)*8,SPRITE_WIDTH)
	}
	if (controller.getkeypress(LEFT)){
	while(this.gridCheck(this.x-1,this.y)) this.x -= 1;
	this.dash = new dashFX((oldx+1)*8,oldy*8,(this.x-oldx)*8,SPRITE_WIDTH)
	}
	if (controller.getkeypress(UP)){
	while(this.gridCheck(this.x,this.y-1))this.y -= 1;
	this.dash = new dashFX(oldx*8,(oldy+1)*8,SPRITE_WIDTH,(this.y-oldy)*8)
	}
	if (controller.getkeypress(DOWN)){
	while(this.gridCheck(this.x,this.y+1))this.y += 1;
	this.dash = new dashFX(oldx*8,oldy*8,SPRITE_WIDTH,(this.y-oldy)*8)
	}
	if (this.y > 8) this.y = 0;
	if (this.y < 0) this.y = 8;
	if (this.x > 15) this.x = 0;
	if (this.x < 0) this.x = 15;
  };
  gridCheck(x,y){
	if (GAME.room[y][x] != 'wall') return true
  }
}

class Zombie extends Actor{
  constructor(x,y){
	super(x,y);
	this.sprite = SPRITES.zombie;
	this.colors = [COLORS.Dgreen,COLORS.Lgreen]
  }
  update(){}
}

class Goblin extends Actor{
  constructor(x,y){
	super(x,y);
	this.sprite = SPRITES.goblin;
	this.colors = [COLORS.Lgreen,COLORS.green,COLORS.Dgreen,COLORS.Dgreen]
	//this.colors = [COLORS.Lgreen,COLORS.green,COLORS.black,COLORS.orange]
	//this.colors = [COLORS.Lgreen,COLORS.Lgreen,COLORS.black,COLORS.Lgreen]
  }
  update(){}
}

class GameControl{

  constructor(){
	this.resetLevel();
	this.buildRoom(ROOMS[0]);
  }

  resetLevel(){
	this.room = [[],[],[],[],[],[],[],[]];
	this.actors = {
	  enemies:[],
	  walls:  [],
	  stairs: [],
	  wallsFG:[]
	}
  }

  draw(){
	const A = this.actors;
	const OBJS = [...A.walls,...A.enemies,A.player];
	OBJS.forEach(obj => {
	  obj.draw();
	})
  }

  update(){
	this.actors.player.update()
  }
  buildRoom(map){
	const WIDTH = 8;
	for(let row = 0; row < WIDTH; row++){
	  for (let col = 0; col < WIDTH; col++){
		switch(map[row*WIDTH + col]){
		  case '1': 
			this.room[row].push('wall')
			this.actors.walls.push(new Actor(col,row))
		  break;
		  case 'p':
			this.actors.player = new Hero(col,row)
		  default: this.room[row].push('empty')

		}
	  }	
	}
  }
}

const ROOMS = {
  0:
	'11111111'+
	'1......1'+
	'1......1'+
	'1...p.11'+
	'11.....1'+
	'1.z....1'+
	'1....z.1'+
	'11111111'
}

function mainloop(){
ctx.clearRect(0,0,canvas.width,canvas.height)
GAME.update();
GAME.draw();
requestAnimationFrame(mainloop)
}
var GAME = new GameControl()
gob = new Goblin(10,4)
zom = new Zombie(8,1)
mainloop()





</script>